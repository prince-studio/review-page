<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Suggested Review</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:#f5f7f8;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }
  .wrap{
    width:100%;
    max-width:420px;
    text-align:center;
    padding:24px;
    position:relative;
  }
  h1{
    margin:0 0 16px;
    color:#198754;
    font-size:26px;
  }

  /* REVIEW BOX */
  .review-box{
    background:#ffffff;
    border-radius:12px;
    padding:18px 16px;
    min-height:90px;
    box-shadow:0 4px 14px rgba(0,0,0,0.06);
    font-size:15px;
    line-height:1.5;
    text-align:left;
    color:#9aa0a6;
    margin-bottom:18px;
    position:relative;
  }

  /* LOADING SPINNER */
  .spinner {
    width:26px;
    height:26px;
    border:3px solid #ddd;
    border-top-color:#198754;
    border-radius:50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
    margin-top:4px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* BUTTON (hidden initially) */
  button{
    width:100%;
    border:none;
    border-radius:999px;
    padding:12px 18px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    background:#198754;
    color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
    opacity:0;
    pointer-events:none;
    transition:opacity .6s ease, transform .15s ease, box-shadow .15s ease;
  }
  button.show {
    opacity:1;
    pointer-events:auto;
  }
  button:hover{
    transform:translateY(-1px);
    box-shadow:0 10px 24px rgba(0,0,0,0.22);
    opacity:.96;
  }

  /* FULLSCREEN COUNTDOWN OVERLAY */
  .count-overlay{
    position:fixed;
    inset:0;
    background:rgba(245,247,248,0.95);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:999;
  }

  .count-wrapper{
    position:relative;
    width:130px;
    height:130px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .count-svg{
    width:130px;
    height:130px;
    transform:rotate(-90deg); /* start from top */
  }

  .circle-bg{
    fill:transparent;          /* inner fully transparent */
    stroke:#d4d4d4;            /* grey outer ring */
    stroke-width:10;
  }

  .circle-fg{
    fill:transparent;          /* transparent centre */
    stroke:#198754;            /* green progress */
    stroke-width:10;
    stroke-linecap:round;
    stroke-dasharray:327;      /* set in JS but keep default */
    stroke-dashoffset:327;
  }

  .count-num{
    position:absolute;
    font-size:52px;
    font-weight:700;
    color:#b31212;             /* red number */
  }

  .count-text{
    margin-top:14px;
    font-size:15px;
    font-weight:500;
    color:#444;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Suggested Review</h1>

  <div id="reviewBox" class="review-box">
    <div class="spinner"></div>
  </div>

  <button id="copyBtn">Copy &amp; Open Google</button>

  <!-- COUNTDOWN OVERLAY -->
  <div id="countOverlay" class="count-overlay">
    <div class="count-wrapper">
      <svg class="count-svg" viewBox="0 0 120 120">
        <circle class="circle-bg" cx="60" cy="60" r="52"></circle>
        <circle id="circleFg" class="circle-fg" cx="60" cy="60" r="52"></circle>
      </svg>
      <span id="countNum" class="count-num">5</span>
    </div>
    <div id="countText" class="count-text">Waiting... 5 Sec</div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx579TE5jN8VcMWzrAjzLlaieDpk02zglUH0mmQsEb9NKnQnCz6f33iYRGxcEqnwp-pGw/exec";
  const GOOGLE_REVIEW_URL = "https://g.page/r/CVkZtJEDPD28EBM/review";

  const reviewBox   = document.getElementById("reviewBox");
  const copyBtn     = document.getElementById("copyBtn");

  const countOverlay = document.getElementById("countOverlay");
  const countNum     = document.getElementById("countNum");
  const countText    = document.getElementById("countText");
  const circleFg     = document.getElementById("circleFg");

  let currentReviewText = "";
  let reviewLoaded = false;

  const COUNT_SECONDS = 5;
  const CYCLE_MS = COUNT_SECONDS * 1000;

  // SVG circle circumference (2πr, r = 52)
  const RADIUS = 52;
  const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
  circleFg.style.strokeDasharray = CIRCUMFERENCE;
  circleFg.style.strokeDashoffset = CIRCUMFERENCE;

  let animId = null;
  let cycleStart = null;

  function setProgress(progress) {
    // progress: 0 → 1
    const offset = CIRCUMFERENCE * (1 - progress);
    circleFg.style.strokeDashoffset = offset;
  }

  function startCountdown() {
    cycleStart = performance.now();
    countOverlay.style.display = "flex";
    setProgress(0);

    if (animId) cancelAnimationFrame(animId);

    const frame = (now) => {
      if (reviewLoaded) return; // stop drawing, overlay hide alag fn me

      const elapsedTotal = now - cycleStart;
      const elapsedInCycle = elapsedTotal % CYCLE_MS;

      const remainingMs = CYCLE_MS - elapsedInCycle;
      let secLeft = Math.ceil(remainingMs / 1000);
      if (secLeft < 1) secLeft = 1;

      countNum.textContent = secLeft;
      countText.textContent = "Waiting... " + secLeft + " Sec";

      const progress = elapsedInCycle / CYCLE_MS; // 0 → 1
      setProgress(progress);

      animId = requestAnimationFrame(frame);
    };

    animId = requestAnimationFrame(frame);
  }

  function stopCountdown() {
    if (animId) {
      cancelAnimationFrame(animId);
      animId = null;
    }
    countOverlay.style.display = "none";
    copyBtn.classList.add("show");
  }

  async function loadReview() {
    try {
      const res = await fetch(API_URL, { cache: "no-store" });
      const data = await res.json();

      currentReviewText = data.text || "";
      reviewBox.textContent = currentReviewText || "Review text blank aaya hai.";

      reviewLoaded = true;
      stopCountdown();

      console.log("Review index:", data.index);
    } catch (err) {
      console.error("Error loading review:", err);
      reviewBox.textContent =
        "Review text load nahi ho paaya. Thodi der baad phir try karein.";

      reviewLoaded = true;
      stopCountdown();
    }
  }

  copyBtn.addEventListener("click", async () => {
    if (!currentReviewText) {
      window.open(GOOGLE_REVIEW_URL, "_blank");
      return;
    }

    try {
      await navigator.clipboard.writeText(currentReviewText);
    } catch (err) {
      const ta = document.createElement("textarea");
      ta.value = currentReviewText;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }

    window.open(GOOGLE_REVIEW_URL, "_blank");
  });

  // Start
  startCountdown();
  loadReview();
</script>
</body>
</html>
